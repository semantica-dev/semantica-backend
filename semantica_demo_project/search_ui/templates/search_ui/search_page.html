{% extends "search_ui/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-2">

    <div class="row justify-content-center align-items-center text-center search-block-container 
        {% if search_results or performed_search and not search_results and not search_form.errors %}
            search-block-with-results
        {% else %}
            search-block-initial
        {% endif %}
    ">
        <div class="col-md-10 col-lg-8"> {# Увеличил ширину колонки для лучшего вида #}

            <div class="mb-4" id="brand-logo">
                <h1 class="display-3 fw-bold text-primary mb-1">
                    <i class="bi bi-search-heart-fill me-2"></i>SemanticaПоиск
                </h1>
                <p class="lead text-muted">Ваша персональная система семантического поиска</p>
            </div>

            <form method="get" action="{% url 'search_ui:search_page' %}" class="mb-3">
                <div class="input-group input-group-lg shadow-sm">
                    <input type="text" name="{{ search_form.query_text.name }}" class="form-control"
                        placeholder="{{ search_form.query_text.field.widget.attrs.placeholder }}"
                        id="{{ search_form.query_text.id_for_label }}" {% if search_form.query_text.value %}
                        value="{{ search_form.query_text.value }}" {% endif %}>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-search me-1"></i>Найти
                    </button>
                </div>
                {% for error in search_form.query_text.errors %}
                <div class="invalid-feedback d-block text-center mt-1">{{ error }}</div>
                {% endfor %}
                <label for="{{ search_form.query_text.id_for_label }}" class="visually-hidden">{{
                    search_form.query_text.label }}</label>
            </form>
        </div>
    </div>

    {% if performed_search %}
    <hr class="my-4 {% if not search_results and search_form.errors %}d-none{% endif %}">
    <div class="row">
        <div class="col-12">
            {% if search_results %}
            <p class="text-muted mb-3">
                Найдено результатов: {{ total_found }}
                {% if total_found != search_results|length %}(показано {{ search_results|length }}){% endif %}.
                Время выполнения: {{ query_time_ms }} мс.
            </p>

            {% for item in search_results %}
            <div class="card mb-3 shadow-sm search-result-item">
                <div class="card-body">
                    <h5 class="card-title mb-1">
                        {% if item.url %}
                        <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer"
                            class="text-decoration-none">{{ item.title|default:"Без заголовка" }}</a>
                        <small><i class="bi bi-link-45deg"></i></small>
                        {% elif item.original_file_name %}
                        <span class="fw-semibold">{{ item.title|default:item.original_file_name }}</span>
                        <small class="text-muted ms-2">(Файл: {{ item.original_file_name }}) <i
                                class="bi bi-file-earmark-text"></i></small>
                        {% else %}
                        <span class="fw-semibold">{{ item.title|default:"Без заголовка" }}</span>
                        {% endif %}
                    </h5>
                    <p class="card-text small text-muted mb-2">
                        <span class="badge bg-light text-dark me-2">Релевантность: {{ item.relevance_score|floatformat:2
                            }}</span>
                        <span class="text-capitalize">Тип: {{ item.source_type }}</span>
                        | ID: {{ item.document_id|truncatechars:15 }}
                    </p>
                    <p class="card-text snippet mb-0">
                        {% autoescape off %}
                        {{ item.snippet|default:"Нет описания."|truncatewords_html:60 }}
                        {% endautoescape %}
                    </p>
                </div>
            </div>
            {% endfor %}

            {% elif not search_form.errors %}
            <div class="alert alert-info mt-4" role="alert">
                По вашему запросу "{{ request.GET.query_text }}" ничего не найдено.
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .search-block-container {
        /* Новый класс для общего контейнера поиска */
        transition: all 0.3s ease-in-out;
        /* Плавный переход для min-height */
    }

    .search-block-initial {
        min-height: calc(80vh - 56px);
        /* 80% высоты видимой области минус высота навбара */
        display: flex;
        align-items: center;
    }

    .search-block-with-results {
        min-height: auto;
        margin-bottom: 2rem;
        padding-top: 1rem;
        /* Уменьшил отступ сверху, когда есть результаты */
    }

    #brand-logo .display-3 {
        /* Увеличил логотип */
        font-size: 3.5rem;
        /* Или другой размер */
    }

    .search-result-item .card-title a {
        color: #0d6efd;
    }

    .search-result-item .card-title a:hover {
        text-decoration: underline;
    }

    .snippet strong,
    .snippet b {
        background-color: #fff3cd;
        padding: 0.1em 0.2em;
        border-radius: 0.2em;
    }
</style>
{% endblock %}